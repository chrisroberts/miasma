#!/usr/bin/env ruby

require 'vcr'
require 'fileutils'
require 'webmock/minitest'
require 'minitest/autorun'

require 'miasma'

miasma_spec_dir = File.join(File.dirname(File.dirname(__FILE__)), 'test', 'specs')

# Always load in generic model specs
Dir.glob(File.join(spec_dir, 'models', '*.rb')).each do |path|
  require File.expand_path(path)
end

if(ARGV.size == 1)
  library_spec_dir = File.join(Dir.pwd, 'test', 'specs')
  cassette_directory = File.join(library_spec_dir, 'cassettes')

  unless(File.directory?(library_spec_dir))
    $stderr.puts "ERROR: Failed to locate expected spec directory! (#{library_spec_dir})"
    exit -1
  end

  Dir.glob(File.join(library_spec_dir, '**/**/*_spec.rb')).each do |path|
    require File.expand_path(path)
  end

else
  cassette_directory = File.join(miasma_spec_dir, 'cassettes')

  ARGV.slice(1, ARGV.size).each do |path|
    full_path = File.expand_path(path)
    if(File.exists?(full_path))
      require full_path
    else
      $stderr.puts "ERROR: Failed to locate specified path! (#{full_path})"
      exit -1
    end
  end

end

FileUtils.mkdir_p(cassette_directory)

VCR.configure do |c|
  c.cassette_library_dir = cassette_directory
  c.hook_into :webmock
end
